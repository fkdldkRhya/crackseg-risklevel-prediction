# UNet-Base Crack Future Risk Analysis Pipeline

_(YOLOv8 Segmentation + Vizuara UNet + Future-mask UNet All-in-one)_

<div align="left">
ìŠ¤ë§ˆíŠ¸ ê±´ë¬¼ ì•ˆì „ ê´€ë¦¬ë¥¼ ìœ„í•´ Vision &amp; AI ê¸°ìˆ ì„ í™œìš©í•œ ì½˜í¬ë¦¬íŠ¸ í¬ë™ íƒì§€ ë° ë¯¸ë˜ ìœ„í—˜ë„ ì˜ˆì¸¡ íŒŒì´í”„ë¼ì¸
</div>

**Affiliation**

- ìµœì‹œí›ˆ (CHOI SIHUN)
- Department of Smart Convergence Engineering, Hanyang Univ. ERICA

**Contact**

- ğŸ“§ fkdldkrhya@hanyang.ac.kr

**Research Interests**

- AI / Computer Vision / Structural Health Monitoring

---

## 0. ì „ì²´ íŒŒì´í”„ë¼ì¸ ê°œìš”

ì´ ë¦¬í¬ì§€í† ë¦¬ëŠ” **ë‹¨ì¼ ìŠ¤í¬ë¦½íŠ¸** `risklevel_prediction.py` ì•ˆì—ì„œ  
ë‹¤ìŒ ê³¼ì •ì„ **end-to-end**ë¡œ ìˆ˜í–‰í•˜ëŠ” íŒŒì´í”„ë¼ì¸ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

1. ì…ë ¥ ì½˜í¬ë¦¬íŠ¸ ì´ë¯¸ì§€ì—ì„œ **YOLOv8 ì„¸ê·¸ë©˜í…Œì´ì…˜**ìœ¼ë¡œ í¬ë™ í›„ë³´ **ROI ë§ˆìŠ¤í¬** ìƒì„±
2. ì „ì²´ ì´ë¯¸ì§€ë¥¼ **Vizuara UNet**ì— ë„£ì–´ **í¬ë™ í™•ë¥ ë§µ(UNet_Prob)** ìƒì„±
3. YOLO ROI ì •ë³´ë¥¼ ì´ìš©í•´ **í™•ë¥ ë§µì„ boost** í•˜ëŠ” ê°€ì¤‘ì¹˜ ì•™ìƒë¸”

   \[
   \text{Final_Prob} = \mathrm{clip}(\text{UNet_Prob} + \alpha \cdot \text{YOLO_Mask}, 0, 1)
   \]

   - `YOLO_BOOST_ALPHA = Î±` (ê¸°ë³¸ 0.30)

4. **Final_Prob + ì—ì§€(edge) íŠ¹ì§•**ì„ ì‚¬ìš©í•´ **GMM í´ëŸ¬ìŠ¤í„°ë§**ìœ¼ë¡œ ì´ì§„í™” â†’ **base now ë§ˆìŠ¤í¬**
5. ë„ˆë¬´ ì‘ì€ blob / ì›í˜•ì— ê°€ê¹Œìš´ blob / aspectê°€ ì‘ì€ ì¡ìŒì„ ì œê±° â†’ **ìµœì¢… now ë§ˆìŠ¤í¬**
6. ìµœì¢… now ë§ˆìŠ¤í¬ë¥¼ **future-mask UNet**ì— ë„£ì–´, íƒ€ì¼ë§ ê¸°ë°˜ìœ¼ë¡œ **ë¯¸ë˜ í¬ë™ ë§ˆìŠ¤í¬** ì˜ˆì¸¡
7. now / future ë§ˆìŠ¤í¬ ê°ê°ì— ëŒ€í•´:

   - **ê¸€ë¡œë²Œ ìœ„í—˜ë„ ë¶„ì„** (Severity S, Probability P, Risk R, Level A~D)
   - **ì»´í¬ë„ŒíŠ¸ë³„(ê°€ì§€ë³„) ìœ„í—˜ë„ ë¶„ì„** ë° bounding box ì‹œê°í™”

8. ë§ˆì§€ë§‰ìœ¼ë¡œ **í˜„ì¬ vs ë¯¸ë˜ ìœ„í—˜ë„ ë³€í™”** (Î”S, Î”R)ë¥¼ ê³„ì‚°í•˜ê³  ì½˜ì†”ì— ìš”ì•½ ì¶œë ¥

---

## 1. íŒŒì¼ êµ¬ì„±

í˜„ì¬ ë²„ì „ì˜ í•µì‹¬ì€ ë‹¤ìŒ í•œ íŒŒì¼ì…ë‹ˆë‹¤.

- `risklevel_prediction.py`
  - YOLOv8 ROI ì„¸ê·¸ë©˜í…Œì´ì…˜
  - Vizuara UNet í™•ë¥ ë§µ + YOLO boost + GMM ì´ì§„í™”
  - ì›í˜•/ì¡ìŒ ì œê±° ë° ì»´í¬ë„ŒíŠ¸ ë¶„ë¦¬
  - future-mask UNet íƒ€ì¼ë§ ì¶”ë¡ 
  - now/future ê¸€ë¡œë²Œ & ì»´í¬ë„ŒíŠ¸ë³„ ìœ„í—˜ë„ ë¶„ì„
  - ê²°ê³¼ ì´ë¯¸ì§€ ì €ì¥ & ì½˜ì†” ìš”ì•½ ì¶œë ¥

ì¶”ê°€ë¡œ í•„ìš”í•œ ëª¨ë¸ ê°€ì¤‘ì¹˜:

- `future_mask_unet_h4_v2.pth`
  - CrackSeq ê¸°ë°˜ **ë¯¸ë˜ í¬ë™ ë§ˆìŠ¤í¬** ì˜ˆì¸¡ìš© U-Net ê°€ì¤‘ì¹˜
  - ë¡œë”© ìœ„ì¹˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ì˜ `FUTURE_MODEL_PATH` ì„¤ì •ì„ ë”°ë¦…ë‹ˆë‹¤.

> **ì°¸ê³ **: ë¯¸ë˜ U-Net í•™ìŠµ ìŠ¤í¬ë¦½íŠ¸(`future_unet_train.py.py`)ëŠ” ë³„ë„ íŒŒì¼ë¡œ ì¡´ì¬í•˜ë©°,  
> CrackSeq multi-temporal GT ë§ˆìŠ¤í¬ë¥¼ ì´ìš©í•´ `future_mask_unet_h4_v2.pth`ë¥¼ í•™ìŠµí•©ë‹ˆë‹¤.  
> (ì´ READMEì—ì„œëŠ” **ì¶”ë¡  íŒŒì´í”„ë¼ì¸** ìœ„ì£¼ë¡œ ì„¤ëª…í•©ë‹ˆë‹¤.)

---

## 2. ì„¤ì¹˜ ë° ìš”êµ¬ ì‚¬í•­

### 2.1 Python ë²„ì „

- Python **3.8+** ê¶Œì¥

### 2.2 í•„ìˆ˜ ì˜ì¡´ì„±

```bash
pip install torch torchvision torchaudio

pip install   numpy   opencv-python   scikit-learn   pillow   huggingface_hub   ultralytics
```

ì„ íƒ(ìˆìœ¼ë©´ ë” ì¢‹ìŒ):

```bash
# skeletonizeë¥¼ ìœ„í•´ ximgproc thinningì„ ì“°ê³  ì‹¶ë‹¤ë©´
pip install opencv-contrib-python
```

> `opencv-contrib-python`ì´ ì—†ë”ë¼ë„, ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ì—ì„œ **fallback skeletonization** ë¡œì§ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ë™ì‘ì€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

---

## 3. ì‚¬ìš© ëª¨ë¸ & ì²´í¬í¬ì¸íŠ¸

### 3.1 Vizuara UNet (í˜„ì¬ ë§ˆìŠ¤í¬ìš©)

- Hugging Face Hub: `Vizuara/unet-crack-segmentation`
- ê°€ì¤‘ì¹˜ íŒŒì¼ëª…: `unet_weights_v2.pth`
- ìŠ¤í¬ë¦½íŠ¸ ë‚´ì—ì„œ `hf_hub_download`ë¡œ **ìë™ ë‹¤ìš´ë¡œë“œ**ë©ë‹ˆë‹¤.

ì—­í• :

- í¬ë™ edgeì— íŠ¹í™”ëœ ì „ì²˜ë¦¬(`crack_edge_boost`)ë¥¼ ê±°ì¹œ ì´ë¯¸ì§€ë¥¼ ì…ë ¥ìœ¼ë¡œ ë°›ì•„,
- í”½ì…€ ë‹¨ìœ„ í¬ë™ í™•ë¥ ë§µ `prob_map_unet (H, W, 0~1)` ìƒì„±

### 3.2 YOLOv8 Segmentation (ROI ë§ˆìŠ¤í¬ìš©)

- Hugging Face Hub: `OpenSistemas/YOLOv8-crack-seg`
- ê¸°ë³¸ ê°€ì¤‘ì¹˜ ê²½ë¡œ: `"yolov8x/weights/best.pt"`
- ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€:

  ```python
  YOLO_REPO_ID = "OpenSistemas/YOLOv8-crack-seg"
  YOLO_WEIGHT_FILENAME = "yolov8x/weights/best.pt"
  ```

ì—­í• :

- ì…ë ¥ ì´ë¯¸ì§€ë¥¼ YOLOv8 ì„¸ê·¸ë©˜í…Œì´ì…˜ ëª¨ë¸ì— í†µê³¼ì‹œì¼œ,
- ê²€ì¶œëœ ëª¨ë“  ë§ˆìŠ¤í¬ë¥¼ ORí•œ ê²°ê³¼ë¥¼ **ROI ë§ˆìŠ¤í¬(0/1)**ë¡œ ì‚¬ìš©
- ì´ ROIê°€ Vizuara UNet í™•ë¥ ë§µì„ **boost**í•˜ëŠ” ë° ì‚¬ìš©ë¨

### 3.3 Future-mask U-Net (ë¯¸ë˜ ë§ˆìŠ¤í¬ ì˜ˆì¸¡ìš©)

- ë¡œì»¬ íŒŒì¼: `future_mask_unet_h4_v2.pth`
- ë„¤íŠ¸ì›Œí¬ êµ¬ì¡°: ìŠ¤í¬ë¦½íŠ¸ ë‚´ `FutureMaskUNet`
  - ì…ë ¥: `(1, 1, H, W)` í˜•íƒœì˜ **now ë§ˆìŠ¤í¬ patch**
  - ì¶œë ¥: `(1, 1, H, W)` í˜•íƒœì˜ **ë¯¸ë˜ ë§ˆìŠ¤í¬ logits**

ì—­í• :

- í˜„ì¬(now) ë§ˆìŠ¤í¬ë¥¼ íƒ€ì¼ ë‹¨ìœ„ë¡œ ì…ë ¥ë°›ì•„,
- CrackSeq multi-temporal GTë¥¼ í†µí•´ í•™ìŠµëœ ë¯¸ë˜ í¬ë™ ë¶„í¬ë¥¼ ì˜ˆì¸¡

---

## 4. íŒŒì´í”„ë¼ì¸ ìƒì„¸ ì„¤ëª…

### 4.1 YOLOv8 ROI ë§ˆìŠ¤í¬ ìƒì„±

í•¨ìˆ˜: `generate_yolo_roi_mask_seg(image_path, yolo_model)`

- YOLOv8 segmentationìœ¼ë¡œ inference ìˆ˜í–‰
- ê²°ê³¼ ë§ˆìŠ¤í¬ë“¤ì„ ëª¨ë‘ ORí•˜ì—¬ ë‹¨ì¼ ROI ë§ˆìŠ¤í¬ ìƒì„±
- ROI ë§ˆìŠ¤í¬ë¥¼ ì›ë³¸ í•´ìƒë„ë¡œ ë¦¬ì‚¬ì´ì¦ˆ (`(H, W)` 0/1)
- ì €ì¥ íŒŒì¼:
  - `<base>_yolo_roi_mask.png`
  - `<base>_yolo_roi_overlay.png` (ì›ë³¸ ìœ„ì— ROI ì˜ì—­ì„ ë…¹ìƒ‰ìœ¼ë¡œ í‘œì‹œ)

### 4.2 Vizuara UNet í™•ë¥ ë§µ + YOLO boost + GMM ì´ì§„í™”

#### 4.2.1 Edge-boosted ì…ë ¥ ìƒì„±

í•¨ìˆ˜: `crack_edge_boost(image_bgr)`

- Gray ë³€í™˜ â†’ CLAHEë¡œ ëŒ€ë¹„ í–¥ìƒ
- Sobel + Laplacian ê²°í•©ìœ¼ë¡œ edge ê°•í™”
- edge + intensityë¥¼ í˜¼í•©í•œ gray ì´ë¯¸ì§€ë¥¼ RGBë¡œ ë³€í™˜í•˜ì—¬ UNet ì…ë ¥ìœ¼ë¡œ ì‚¬ìš©

#### 4.2.2 UNet í™•ë¥ ë§µ ìƒì„±

í•¨ìˆ˜: `run_unet_prob_map(model, image_bgr, device)`

- 256Ã—256ìœ¼ë¡œ resize â†’ Vizuara UNet ì¶”ë¡  â†’ sigmoid
- ì›ë³¸ í•´ìƒë„ë¡œ bilinear resizeí•˜ì—¬ `prob_map_unet (H, W, 0~1)` ìƒì„±

#### 4.2.3 YOLO boost ê¸°ë°˜ ì•™ìƒë¸”

í•¨ìˆ˜: `generate_crack_mask_unet_gmm(...)`

- YOLO ROIê°€ ìˆë‹¤ë©´:

  ```python
  prob_map_final = prob_map_unet + YOLO_BOOST_ALPHA * YOLO_Mask
  prob_map_final = np.clip(prob_map_final, 0.0, 1.0)
  ```

- `YOLO_BOOST_ALPHA`ë¥¼ ì¡°ì ˆí•˜ì—¬:
  - YOLOì— ë” ì˜ì¡´ (â†‘): ROI ì•ˆì—ì„œ í™•ë¥ ì´ ê°•í•˜ê²Œ ìƒìŠ¹
  - UNetì— ë” ì˜ì¡´ (â†“): ì „ì—­ ì„¸ê·¸ë©˜í…Œì´ì…˜ì— ë” ì˜ì¡´

ë””ë²„ê·¸ ì¶œë ¥:

- `<base>_unet_prob_raw.png`
- `<base>_unet_prob_boosted.png`

#### 4.2.4 GMM ì´ì§„í™” + ê¸¸ê²Œ ë»—ì€ ì»´í¬ë„ŒíŠ¸ ìœ ì§€

í•¨ìˆ˜: `prob_to_binary_gmm(prob_map_final, image_bgr, n_components)`

- íŠ¹ì§• ë²¡í„°: `[Final_Prob_norm, Edge_norm]`
- `GaussianMixture(n_components=3)`ë¡œ í´ëŸ¬ìŠ¤í„°ë§
- í‰ê·  í™•ë¥ ì´ ë†’ì€ í´ëŸ¬ìŠ¤í„°ë¥¼ í¬ë™ í´ëŸ¬ìŠ¤í„°ë¡œ ì„ íƒ (í•„ìš” ì‹œ 2ê°œê¹Œì§€)
- Morphological open / erodeë¡œ ê°€ë²¼ìš´ ì¡ìŒ ì œê±°
- `keep_elongated_components`:
  - ì„¸ì¥ë¹„(aspect ratio), ì •ìƒí™” ê¸¸ì´(norm_len), ìµœì†Œ ë©´ì  ê¸°ì¤€ìœ¼ë¡œ  
    **ê°€ëŠ˜ê³  ê¸´ ì»´í¬ë„ŒíŠ¸**ë§Œ ìœ ì§€
- `fill_small_holes_by_contours`:
  - ì „ì²´ ì´ë¯¸ì§€ ëŒ€ë¹„ ì‘ì€ ë¹„ìœ¨ì˜ í™€ë§Œ ì±„ì›Œ ë‚´ë¶€ë¥¼ ë©”ì›€

ìµœì¢… ê²°ê³¼:

- `unet_now_mask (H, W, 0/1)`

ì €ì¥:

- `<base>_now_base_mask.png`
- `<base>_now_base_overlay.png`

### 4.3 ì›í˜•/ì¡ìŒ ì œê±° â†’ ìµœì¢… now ë§ˆìŠ¤í¬

í•¨ìˆ˜: `filter_crack_like_components(combined_mask, image_path)`

- ê° connected componentì— ëŒ€í•´:
  - ë©´ì (area) < `MIN_COMP_AREA` â†’ ì œê±°
  - ê¸´ ë³€(long_axis) < `MIN_LONG_AXIS` & aspect < `MIN_ASPECT_RATIO` â†’ ì œê±°
  - **ì›í˜•ì„±(circularity)**:
    - \(\mathcal{C} = 4\pi A / P^2\)
    - \(\mathcal{C} > \text{MAX_CIRCULARITY}\) & aspect < `MIN_ASPECT_RATIO` â†’ ì œê±°
- ë‚˜ë¨¸ì§€ë¥¼ ëª¨ë‘ í•©ì³ ìµœì¢… now ë§ˆìŠ¤í¬ ìƒì„±

ì €ì¥:

- `<base>_now_mask_raw.png`
- `<base>_now_mask_filtered.png`
- `<base>_now_final_overlay.png` (ì›ë³¸ ìœ„ì— ìµœì¢… now ë§ˆìŠ¤í¬ í‘œì‹œ)

### 4.4 íƒ€ì¼ë§ ê¸°ë°˜ ë¯¸ë˜ ë§ˆìŠ¤í¬ ì˜ˆì¸¡

í•¨ìˆ˜: `predict_future_mask_tiled(model, now_mask, device, pred_thresh, tile, stride)`

- now ë§ˆìŠ¤í¬ë¥¼ `tile Ã— tile` í¬ê¸° íŒ¨ì¹˜ë¡œ ìŠ¬ë¼ì´ë”© (stride ê°„ê²©)
- íŒ¨ì¹˜ê°€ ì‘ìœ¼ë©´ zero padding
- ê° íŒ¨ì¹˜ë¥¼ `[0,1]`ë¡œ ì •ê·œí™” í›„ Future U-Netì— í†µê³¼
- í™•ë¥ ë§µì„ ì›ìœ„ì¹˜ì— accumulate í›„ `weight`ë¡œ ì •ê·œí™”
- ìµœì¢…:

  - `future_prob (H, W, 0~1)`
  - `future_bin = (future_prob >= pred_thresh)`

ì €ì¥:

- `<base>_future_prob.png`
- `<base>_future_mask.png`
- `<base>_future_final_overlay.png`

ì½˜ì†”:

- `mean_prob`: ì „ì²´ í‰ê·  ì˜ˆì¸¡ í™•ë¥ 
- `fg_ratio`: ë¯¸ë˜ ë§ˆìŠ¤í¬ foreground ë¹„ìœ¨

### 4.5 ê¸€ë¡œë²Œ & ì»´í¬ë„ŒíŠ¸ë³„ ìœ„í—˜ë„ ë¶„ì„

ê³µí†µ í•¨ìˆ˜: `analyze_mask(image_path, crack_mask, mm_per_pixel, tag)`

#### 4.5.1 Severity (S, 0~1)

`SeverityFeatures`:

- `w_max_mm` : ìµœëŒ€ í¬ë™ í­ (mm)
- `rho_L_per_m` : ë‹¨ìœ„ í­ë‹¹ í¬ë™ ê¸¸ì´ (ì„ í˜• ë°€ë„, 1/m)
- `area_mm2` : í¬ë™ ë©´ì  (mmÂ²)
- `D_f` : í”„ë™íƒˆ ì°¨ì›
- `length_m` : ì´ í¬ë™ ê¸¸ì´ (m)

ê° featureëŠ” ì•„ë˜ ì„ê³„ê°’ì„ ê¸°ì¤€ìœ¼ë¡œ 0~1ë¡œ ì •ê·œí™”ë©ë‹ˆë‹¤.

- í­: `WIDTH_T0_MM`, `WIDTH_T1_MM`
- ë°€ë„: `DENSITY_T0_PER_M`, `DENSITY_T1_PER_M`
- ë©´ì : `AREA_T0_MM2`, `AREA_T1_MM2`
- í”„ë™íƒˆ: `FRACTAL_LOW`, `FRACTAL_HIGH`
- ê¸¸ì´: `LENGTH_T0_M`, `LENGTH_T1_M`

`SeverityScores`:

- `S_w`, `S_density`, `S_area`, `S_fractal`, `S_length`
- ê°€ì¤‘ í‰ê· :

  \[
  S*\text{total} = \frac{\alpha S_w + \beta S*{density} + \gamma S*{area} + \delta S*{fractal} + \epsilon S\_{length}}{\alpha+\beta+\gamma+\delta+\epsilon}
  \]

#### 4.5.2 Probability (P, 0~1)

`ProbabilityInputs`:

- `P_TipSharpness` : tip sharpness ê¸°ë°˜ (ëë‹¨ì´ ì–¼ë§ˆë‚˜ ë¾°ì¡±í•œì§€)
- `P_WidthGradient` : skeleton ìƒ í­ ë³€í™”(gradient) ê¸°ë°˜
- `P_Orientation` : í¬ë™ ë°©í–¥(angle) ë° ê¸¸ì´ì— ë”°ë¥¸ ìœ„í—˜ë„

ê³„ì‚° ë°©ì‹:

1. skeleton endpoint ì£¼ë³€/ë‚´ë¶€ í­ì„ ë¹„êµí•˜ì—¬ tipì´ ê°€ëŠ˜ìˆ˜ë¡ ì ìˆ˜ â†‘
2. skeleton í­ ë¶„í¬ì˜ 10/90 percentile ì°¨ì´ë¥¼ í†µí•´ í­ ë³€í™”ëŸ‰ ì •ê·œí™”
3. PCA ê¸°ë°˜ ì£¼ ë°©í–¥ì„ êµ¬í•´ angle â†’ orientation risk base (sin(2Î¸) í˜•íƒœ)  
   ì—¬ê¸°ì— `S_length`ë¥¼ ê³±í•´ `P_Orientation` êµ¬ì„±

ìµœì¢…:

\[
P = \frac{\alpha P*{Tip} + \beta P*{Grad} + \gamma P\_{Orient}}{\alpha+\beta+\gamma}
\]

ê¸°ë³¸ì ìœ¼ë¡œ Î±=Î²=Î³=1ì…ë‹ˆë‹¤.

#### 4.5.3 Risk (R, 0~1) ë° Level (A~D)

í•¨ìˆ˜: `compute_risk(img_path, S, P, mode="weighted_sum")`

- `mode="product"`: \(R = S \cdot P\)
- `mode="weighted_sum"` (ê¸°ë³¸):

  \[
  R = w_S S + w_P P,\quad w_S + w_P = 1
  \]

Risk Level ë¶„ë¥˜:

- `R < 0.2` â†’ Level A
- `0.2 â‰¤ R < 0.4` â†’ Level B
- `0.4 â‰¤ R < 0.7` â†’ Level C
- `0.7 â‰¤ R` â†’ Level D

#### 4.5.4 ì»´í¬ë„ŒíŠ¸ë³„ ë¶„ì„ & BBox ì‹œê°í™”

í•¨ìˆ˜: `analyze_components(image_path, mask, mm_per_pixel, tag_prefix)`

- connected componentë¥¼ í•˜ë‚˜ì˜ í¬ë™ ê°€ì§€ë¡œ ë³´ê³  ê° ê°€ì§€ì— ëŒ€í•´ `analyze_mask` ìˆ˜í–‰
- ê° ì»´í¬ë„ŒíŠ¸ì— ëŒ€í•´:
  - ê°œë³„ ë§ˆìŠ¤í¬ & skeleton & orientation ì´ë¯¸ì§€
  - ì›ë³¸ ìœ„ì— í•´ë‹¹ ì»´í¬ë„ŒíŠ¸ë§Œ ë¶‰ê²Œ í‘œì‹œ + bounding box(ì´ˆë¡ìƒ‰) í‘œì‹œ
  - íŒŒì¼ëª… ì˜ˆ: `<base>_now_comp_c3_bbox.png`
- ì „ì²´ ì»´í¬ë„ŒíŠ¸ bboxë¥¼ í•œ ì¥ì— ëª¨ì€ ì´ë¯¸ì§€ë„ ìƒì„±:
  - `<base>_now_comp_components_bbox_all.png`
  - `<base>_future_comp_components_bbox_all.png`

---

## 5. ë©”ì¸ ì‹¤í–‰ ë°©ë²•

### 5.1 ìŠ¤í¬ë¦½íŠ¸ ë‚´ í•˜ë“œì½”ë”© íŒŒë¼ë¯¸í„°

`run_pipeline()` ìƒë‹¨ì—ì„œ ë‹¤ìŒì„ ìˆ˜ì •í•©ë‹ˆë‹¤.

```python
def run_pipeline():
    # ======== ì—¬ê¸°ë¥¼ ë„ˆ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì • =========
    IMAGE_PATH = "a.png"                    # ë¶„ì„í•  ì´ë¯¸ì§€ ê²½ë¡œ
    MM_PER_PIXEL = DEFAULT_MM_PER_PIXEL     # ì´ë¯¸ì§€ ìŠ¤ì¼€ì¼ (mm/px)
    FUTURE_MODEL_PATH = "future_mask_unet_h4_v2.pth"  # ë¯¸ë˜ UNet ê°€ì¤‘ì¹˜ ê²½ë¡œ
    # ======================================
```

- `IMAGE_PATH` : ë¶„ì„í•  ì½˜í¬ë¦¬íŠ¸ ì´ë¯¸ì§€ íŒŒì¼
- `MM_PER_PIXEL` : í”½ì…€ë‹¹ mm (ì—†ìœ¼ë©´ 1.0ìœ¼ë¡œ ë‘ê³  ìƒëŒ€ ë¹„êµìš©ìœ¼ë¡œ ì‚¬ìš©)
- `FUTURE_MODEL_PATH` : future-mask U-Net ê°€ì¤‘ì¹˜ íŒŒì¼ ìœ„ì¹˜

### 5.2 ì‹¤í–‰

```bash
python risklevel_prediction.py
```

### 5.3 ì¶œë ¥ ê²°ê³¼

- ëª¨ë“  ê²°ê³¼ ì´ë¯¸ì§€ëŠ” **`out/` í´ë”**ì— ì €ì¥ë©ë‹ˆë‹¤.
- ì½˜ì†”ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ìš”ì•½ì´ ì¶œë ¥ë©ë‹ˆë‹¤.

```text
===== SUMMARY (GLOBAL) =====
Image         : a.png
mm_per_pixel  : 0.10
---- NOW GLOBAL ----
S_now = ...
P_now = ...
R_now = ..., Level=...
---- FUTURE GLOBAL ----
S_future = ...
P_future = ...
R_future = ..., Level=...
---- Î”(ë³€í™”ëŸ‰) ----
Î”S = ...
Î”R = ...

===== SUMMARY (COMPONENT COUNT) =====
now_components    : N_now
future_components : N_future

[INFO] ëª¨ë“  ê²°ê³¼ ì´ë¯¸ì§€ëŠ” out/ í´ë”ì— ì €ì¥ë¨.
```

---

## 9. ì‹¤í–‰ ì˜ˆì‹œ

### 9.1 Future-mask U-Net í•™ìŠµ

```bash
python future_unet_train.py.py \
  --data_root ./crackseq_dataset_multi_mono_patches/data/multi-temporal \
  --horizon_steps 4 \
  --epochs 50 \
  --batch_size 8 \
  --lr 1e-4 \
  --save_path future_mask_unet_h4_v2.pth
```

### 9.2 í˜„ì¬+ë¯¸ë˜ ìœ„í—˜ë„ í‰ê°€ (UNet+GMM ê¸°ë°˜ now-mask)

```bash
python risklevel_prediction.py G.png \
  --mm_per_pixel 0.1 \
  --model_path future_mask_unet_h4_v2.pth \
  --now_mask_mode unet \
  --tile 128 \
  --stride 64 \
  --pred_thresh 0.5 \
  --save_debug
```

### 9.3 í˜„ì¬+ë¯¸ë˜ ìœ„í—˜ë„ í‰ê°€ (Otsu ê¸°ë°˜ now-mask)

```bash
python risklevel_prediction.py G.png \
  --mm_per_pixel 0.1 \
  --model_path future_mask_unet_h4_v2.pth \
  --now_mask_mode otsu
```

---

## 10. íŠœë‹ íŒ

- `horizon_steps`
  - ë” í° Î”: ë” ë¨¼ ë¯¸ë˜ ì˜ˆì¸¡ â†’ ë‚œì´ë„/ë¶ˆí™•ì‹¤ì„± ì¦ê°€
- `min_fg_ratio`
  - ë„ˆë¬´ í¬ë©´ ìƒ˜í”Œ ìˆ˜ê°€ ì¤„ì–´ë“¤ê³ , ë„ˆë¬´ ì‘ìœ¼ë©´ trivial ìƒ˜í”Œì´ ë§ì•„ì§
- `pos_weight`
  - ìë™ê°’ì„ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©í•˜ë˜, í•„ìš” ì‹œ `--pos_weight_override`ë¡œ ì¡°ì •
- `tile`, `stride`
  - ì‘ì€ stride (overlap ë§ìŒ): ë§¤ë„ëŸ¬ìš´ ì˜ˆì¸¡ but ëŠë¦¼
  - í° stride: ë¹ ë¥´ì§€ë§Œ íƒ€ì¼ ê²½ê³„ ì•„í‹°íŒ©íŠ¸ ê°€ëŠ¥
- Severity/Probability/Risk ê°€ì¤‘ì¹˜
  - ë„ë©”ì¸ ê´€ì ì—ì„œ í­/ê¸¸ì´/ë°€ë„/ê°ë„ ë“±ì— ê°€ì¤‘ì¹˜ë¥¼ ë‹¤ë¥´ê²Œ ì¤„ ìˆ˜ ìˆìŒ

---

ì´ READMEëŠ” `future_unet_train.py.py`ì™€ `risklevel_prediction.py`ì˜ ì „ì²´ ë™ì‘ì„  
í•œ ë²ˆì— ì´í•´í•˜ê³  ì¬í˜„í•  ìˆ˜ ìˆë„ë¡ ì •ë¦¬í•œ ë¬¸ì„œì…ë‹ˆë‹¤.

# LICENSE

BSD 2-Clause License

Copyright (c) 2023, CHOI SI-HUN

Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
